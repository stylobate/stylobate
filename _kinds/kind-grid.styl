grid-col-count($where)
  $got_count = utilus_get($where, 'count', 0)
  $actual_count = 0
  $have_units = 0
  for $item in $where
    $item_col = utilus_get($item, '-col')
    if $item_col
      $actual_count = $actual_count + 1
      unless utilus_get_unit($item_col)
        $have_units = $have_units + 1

  if $got_count >= $actual_count
    return ($got_count) ($got_count - ($actual_count - $have_units))
  else
    return $actual_count $have_units


process-grid-cols($where)
  $result = 'total_count' 0,
            'cols_widths' (),
            'total_units' ('px' 0px) ('em' 0em) ('rem' 0rem) ('%' 0),
            'gutter' utilus_get($where, 'gutter'),
            'shrinkers' ()

  $got_count = utilus_get($where, 'count', 0)
  $actual_count = 0
  $without_units = 0

  for $item in $where
    $item_col = utilus_get($item, '-col')
    if $item_col
      $actual_count = $actual_count + 1
      
      $items_unit = utilus_get_unit($item_col)
      if $items_unit
        $index = utilus_get(('px' 1) ('em' 2) ('rem' 3) ('%' 4), unit($items_unit))
        push($result[1][1], $items_unit)
        $result[2][$index][1] = $result[2][$index][1] + unit($items_unit,'')
      else
        push($result[1][1], -1)
        $without_units = $without_units + 1

  // If total count is more than cols described, fill the cols with the rest
  if $got_count > $actual_count
    for $item in 1..($got_count - $actual_count)
      push($result[1][1], -1)
      $without_units = $without_units + 1

  // Calculate unset percents
  if $without_units
    $width = ((100 - $result[2][4][1]) / $without_units)
    for $item, $index in $result[1][1]
      if $item == -1
        $result[1][1][$index] = unit($width,'%')
        $result[2][4][1] = $result[2][4][1] + $width
        
  // Calculate shrinkers (total sums of units > 0 including gutters)
  for $unit in utilus_get($result, 'total_units')
    if not unit($unit[1]) in ('' '%')
      $current_unit_width = $unit[1]
      if unit($result[3][1]) == unit($unit[1])
        $current_unit_width = round($current_unit_width + $result[3][1],9)
      if $current_unit_width > 0
        push($result[4][1], $current_unit_width)

  // Set the proper total count  
  $result[0][1] = length($result[1][1])

  return $result

kind-grid()
  position: relative

  kind-grid_(arguments)

  p(process-grid-cols(arguments))

kind-grid_()
  kind-grid_gutter(arguments)
  kind-grid_nowrap(arguments)
  
kind-grid_gutter()
  $columns = process-grid-cols(arguments)

  $gutter = utilus_get($columns, 'gutter')
  if $gutter
    margin-left: -1*$gutter
    
    unless utilus_get(arguments, '-content')
      $count = grid-col-count(arguments)[0]
      padding-right: $gutter * $count + $columns[2][utilus_get(('px' 1) ('em' 2) ('rem' 3) ('%' 4), unit($gutter))][1]
      
      white-space: nowrap

kind-grid_nowrap()
  if retrieve(arguments, nowrap ellipsis)
    white-space: nowrap

kind-grid-col()
  $width = utilus_get_unit(arguments)
  unless $width
    $width = 100% / utilus_or(grid-col-count(utilus_get(arguments, 'parent'))[1], 1)

  width: $width 

  if absolute in arguments
    position: absolute
    
  else
    kind-block(inline)

    unless parent_get(arguments, '-content')
      $gutter = parent_get(arguments, 'gutter') 
      if $gutter
        margin-left: $gutter

      if utilus_get(arguments, 'nowrap')
        unless parent_get(arguments, 'nowrap')
          white-space: nowrap
      else
        if parent_get(arguments, 'ellipsis')
          white-space: nowrap unless parent_get(arguments, 'nowrap')
          overflow: hidden
          text-overflow: ellipsis
        else
          white-space: normal

kind-grid-content()
  $gutter = parent_get(arguments, 'gutter') 
  if $gutter
    margin-left: $gutter
