$stylobate_extends = ()

stylobate_extends($what, $target)
  $temp = utilus_append($stylobate_extends, utilus_ident($what) utilus_ident($target))
  utilus_reassign($stylobate_extends, $temp)

called_from($where, $what)
  return utilus_get($where, called_from) == utilus_ident($what)

_stylobate($name, $params)
  if not utilus_is_function($name + $params[0])
    error('No such “' + $name + '” — “' + $params[0] + '”')

  $subparams = utilus_remove_first($params)
  push($subparams, (called_from $name + $params[0]))
  $skin_name = $params[0]
  $context = utilus_get($params, 'context', '')

  // Check if the called stylobate extends anything, if so, call it first,
  // and use the extended stylobate for subitems.
  $extended_name = utilus_get($stylobate_extends, $name + $skin_name)
  if $extended_name
    $skin_name = replace('^' + $name, '', $extended_name)
    {$name + $skin_name}($subparams)

  {$name + $params[0]}($subparams) unless $context
  {$context}
    {$name + $params[0]}($subparams) if $context

  for $subitem in $subparams
    // There shouldn't be an `if` inside a {$selector}, 'cause
    // there is a crazy stylus bug. When it would be fixed,
    // revert this version to 669082fb35
    $selector = ''
    $foundsubitem = ''
    if is_array($subitem)
      if type($subitem[0]) in ('ident' 'string')
        if match('^(\-|_)', $subitem[0])
          $foundsubitem = $subitem
          if type($subitem[1]) == 'string'
            if match('&', $subitem[1])
              $selector = $subitem[1]
            else
              $foundsubitem = ''
    else
      if type($subitem) in ('ident' 'string')
        if match('^(\-|_)', $subitem)
          $foundsubitem = $subitem

    call_subitem()
      $subitemparams = remove_first(remove_first($foundsubitem))
      push($subitemparams, (parent $subparams))
      $subitemname = $name + replace('[_-]+$', '', $skin_name) + $foundsubitem[0]
      {$subitemname}($subitemparams) unless $context
      {$context}
        {$subitemname}($subitemparams) if $context


    {$selector}
      content: "" if match(':(after|before)', $selector)
      call_subitem() if $foundsubitem != '' and $selector != ''

    if $selector == '' and $foundsubitem != ''
      call_subitem()

stylobate($name, $params)
  if utilus_is_comma_list($params)
    for $item in $params
      _stylobate($name, $item)
  else
    _stylobate($name, $params)
